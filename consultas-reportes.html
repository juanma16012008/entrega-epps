<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reporte de Entregas de EPP</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      padding: 20px;
      color: #333;
    }
    .form-container {
      background: white;
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 25px;
    }
    .filters-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #495057;
    }
    select, input[type="date"], input[type="month"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      margin-top: 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 25px;
      font-size: 14px;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #3498db;
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background-color: #f5f5f5;
    }
    .no-results {
      margin-top: 20px;
      padding: 15px;
      background: #f8d7da;
      color: #721c24;
      border-radius: 4px;
      text-align: center;
      display: none;
    }
    .results-summary {
      margin-top: 15px;
      padding: 10px;
      background: #e2f3f8;
      border-radius: 4px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Reporte de Entregas de EPP</h2>
    <form id="form-consulta">
      <div class="filters-grid">
        <div>
          <label for="fecha">Fecha específica:</label>
          <input type="date" id="fecha">
        </div>
        <div>
          <label for="mes">Mes:</label>
          <input type="month" id="mes">
        </div>
        <div>
          <label for="area">Área:</label>
          <select id="area"><option value="">Todas</option></select>
        </div>
        <div>
          <label for="colaborador">Colaborador:</label>
          <select id="colaborador"><option value="">Todos</option></select>
        </div>
        <div>
          <label for="supervisor">Supervisor:</label>
          <select id="supervisor"><option value="">Todos</option></select>
        </div>
      </div>
      <button type="submit">Generar Reporte</button>
    </form>

    <div id="mensaje" class="no-results"></div>
    <div id="resumen" class="results-summary"></div>

    <table id="resultados" style="display:none">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Supervisor</th>
          <th>Área</th>
          <th>Cédula Colaborador</th>
          <th>Nombre Colaborador</th>
          <th>Descripción EPP</th>
          <th>Código</th>
          <th>Cantidad</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const supabaseClient = supabase.createClient(
      'https://jvcuujwkniicekolwljs.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2Y3V1andrbmlpY2Vrb2x3bGpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMzE5MzgsImV4cCI6MjA2ODgwNzkzOH0.OFjrtoY0c9SLoDyNYuANxhCSA22cmTyAYfI8ceTICZ8'
    );

    document.getElementById('form-consulta').addEventListener('submit', async (e) => {
      e.preventDefault();

      document.getElementById('mensaje').style.display = 'none';
      document.getElementById('resultados').style.display = 'none';
      document.getElementById('resumen').style.display = 'none';

      const fecha = document.getElementById('fecha').value;
      const mes = document.getElementById('mes').value;
      const area = document.getElementById('area').value;
      const colaborador = document.getElementById('colaborador').value;
      const supervisor = document.getElementById('supervisor').value;

      if (!fecha && !mes) {
        mostrarMensaje('Por favor seleccione una fecha o un mes para consultar.');
        return;
      }

      try {
        let query = supabaseClient
          .from('entregas')
          .select(`
            id, 
            fecha, 
            supervisor:supervisores(nombre_supervisor), 
            area:area(area), 
            cedula_colaborador, 
            nombre_colaborador,
            detalles:detalle_entregas(
              codigo,
              descripcion_epp,
              cantidad,
              epp:epp(descripcion)
            )
          `);

        if (fecha) query = query.eq('fecha', fecha);
        if (mes) {
          const [year, month] = mes.split('-');
          const desde = `${year}-${month}-01`;
          const hasta = new Date(year, month, 0).toISOString().split('T')[0];
          query = query.gte('fecha', desde).lte('fecha', hasta);
        }
        if (area) query = query.eq('area', area);
        if (colaborador) query = query.eq('cedula_colaborador', colaborador);
        if (supervisor) query = query.eq('supervisor', supervisor);

        query = query.order('fecha', { ascending: false });

        const { data: entregas, error } = await query;

        if (error) throw error;
        if (!entregas || entregas.length === 0) {
          mostrarMensaje('No se encontraron entregas con los filtros seleccionados.');
          return;
        }

        mostrarResultados(entregas, fecha || mes);

      } catch (error) {
        console.error('Error en la consulta:', error);
        mostrarMensaje('Ocurrió un error al generar el reporte. Por favor intente nuevamente.');
      }
    });

    function mostrarResultados(entregas, periodo) {
      const tbody = document.querySelector('#resultados tbody');
      tbody.innerHTML = '';
      let totalItems = 0;

      entregas.forEach(entrega => {
        const detalles = entrega.detalles || [];

        if (detalles.length === 0) {
          agregarFila(
            tbody,
            entrega.fecha,
            entrega.supervisor?.nombre_supervisor || 'N/A',
            entrega.area?.area || 'N/A',
            entrega.cedula_colaborador,
            entrega.nombre_colaborador,
            'N/A',
            'N/A',
            'N/A'
          );
        } else {
          detalles.forEach(detalle => {
            agregarFila(
              tbody,
              entrega.fecha,
              entrega.supervisor?.nombre_supervisor || 'N/A',
              entrega.area?.area || 'N/A',
              entrega.cedula_colaborador,
              entrega.nombre_colaborador,
              detalle.descripcion_epp || detalle.epp?.descripcion || 'N/A',
              detalle.codigo || 'N/A',
              detalle.cantidad || 'N/A'
            );
            totalItems++;
          });
        }
      });

      document.getElementById('resumen').innerHTML = `
        <strong>Resultados:</strong> ${entregas.length} entregas con ${totalItems} items de EPP
        ${periodo ? `para ${periodo.includes('-') ? 'el mes' : 'la fecha'} ${periodo}` : ''}
      `;
      document.getElementById('resumen').style.display = 'block';
      document.getElementById('resultados').style.display = 'table';
    }

    function agregarFila(tbody, fecha, supervisor, area, cedula, nombre, descripcion, codigo, cantidad) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${fecha}</td>
        <td>${supervisor}</td>
        <td>${area}</td>
        <td>${cedula}</td>
        <td>${nombre}</td>
        <td>${descripcion}</td>
        <td>${codigo}</td>
        <td>${cantidad}</td>
      `;
      tbody.appendChild(row);
    }

    function mostrarMensaje(texto) {
      const mensaje = document.getElementById('mensaje');
      mensaje.textContent = texto;
      mensaje.style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', cargarFiltros);

    async function cargarFiltros() {
      const [{ data: areas }, { data: colaboradores }, { data: supervisores }] = await Promise.all([
        supabaseClient.from('area').select(),
        supabaseClient.from('colaboradores').select(),
        supabaseClient.from('supervisores').select()
      ]);

      cargarSelect('area', areas, 'id', 'area');
      cargarSelect('colaborador', colaboradores, 'cedula', 'nombre_colaborador');
      cargarSelect('supervisor', supervisores, 'cedula', 'nombre_supervisor');
    }

    function cargarSelect(id, data, valueField, textField) {
      const select = document.getElementById(id);
      data.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item[valueField];
        opt.textContent = item[textField];
        select.appendChild(opt);
      });
    }
  </script>
</body>
</html>




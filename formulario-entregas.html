<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Entregas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }
    .form-container {
      background-color: #fff;
      max-width: 700px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    select, input[type="text"], input[type="date"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    .epp-group {
      background: #f9f9f9;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    button {
      width: 100%;
      padding: 12px;
      background-color: #2980b9;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #1c5985;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h1>Entrega de EPPs</h1>
    <form id="form-entrega">
      <label>Fecha:</label>
      <input type="date" id="fecha" required>

      <label>Supervisor:</label>
      <select id="supervisor" required></select>

      <label>Área:</label>
      <select id="area" required></select>

      <label>Nombre del colaborador:</label>
      <select id="nombre_colaborador" required></select>

      <label>Cédula del colaborador:</label>
      <input type="text" id="cedula_colaborador" disabled>

      <div id="epp-container"></div>

      <button type="button" onclick="agregarEPP()">➕ Agregar otro EPP</button>
      <br><br>
      <button type="submit">Guardar entrega</button>
    </form>
  </div>

  <script>
    const supabaseClient = supabase.createClient(
      'https://jvcuujwkniicekolwljs.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2Y3V1andrbmlpY2Vrb2x3bGpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMzE5MzgsImV4cCI6MjA2ODgwNzkzOH0.OFjrtoY0c9SLoDyNYuANxhCSA22cmTyAYfI8ceTICZ8'
    );

    document.addEventListener("DOMContentLoaded", () => {
      setFechaHoy();
      cargarDatos().then(() => agregarEPP());
    });

    function setFechaHoy() {
      const tzoffset = new Date().getTimezoneOffset() * 60000;
      const localISODate = new Date(Date.now() - tzoffset).toISOString().split("T")[0];
      document.getElementById("fecha").value = localISODate;
    }

    async function cargarDatos() {
      const [supervisores, areas, colaboradores, epps] = await Promise.all([
        supabaseClient.from('supervisores').select('cedula, nombre_supervisor'),
        supabaseClient.from('area').select('id, area'),
        supabaseClient.from('colaboradores').select('cedula, nombre_colaborador'),
        supabaseClient.from('epp').select('codigo, descripcion')
      ]);

      window.listaEpps = epps.data;

      llenarSelect('supervisor', supervisores.data, 'cedula', 'nombre_supervisor');
      llenarSelect('area', areas.data, 'id', 'area');
      llenarSelect('nombre_colaborador', colaboradores.data, 'cedula', 'nombre_colaborador');

      document.getElementById('nombre_colaborador').addEventListener('change', e => {
        const cedula = e.target.value;
        document.getElementById('cedula_colaborador').value = cedula || '';
      });
    }

    function llenarSelect(id, data, valueKey, textKey) {
      const select = document.getElementById(id);
      select.innerHTML = '<option value="">Seleccione...</option>';
      data.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item[valueKey];
        opt.textContent = item[textKey];
        select.appendChild(opt);
      });
    }

    function llenarSelectEPP(select, epps) {
      select.innerHTML = '<option value="">Seleccione...</option>';
      epps.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.codigo;
        opt.textContent = item.descripcion;
        select.appendChild(opt);
      });
      select.addEventListener('change', e => {
        const codigo = e.target.value;
        const inputCodigo = e.target.closest('.epp-group').querySelector('.codigo');
        inputCodigo.value = codigo || '';
      });
    }

    function agregarEPP() {
      const container = document.getElementById('epp-container');
      const nuevo = document.createElement('div');
      nuevo.className = 'epp-group';
      nuevo.innerHTML = `
        <label>EPP (Descripción):</label>
        <select class="epp-select" required></select>
        <input type="hidden" class="codigo">
      `;
      container.appendChild(nuevo);

      if (window.listaEpps && window.listaEpps.length > 0) {
        llenarSelectEPP(nuevo.querySelector('.epp-select'), window.listaEpps);
      } else {
        console.warn("⚠️ No se han cargado los EPPs todavía.");
      }
    }

    document.getElementById('form-entrega').addEventListener('submit', async (e) => {
      e.preventDefault();

      const fecha = document.getElementById('fecha').value;
      const supervisor = document.getElementById('supervisor').value;
      const area = document.getElementById('area').value;
      const cedula = document.getElementById('cedula_colaborador').value;
      const nombre = document.getElementById('nombre_colaborador').selectedOptions[0]?.textContent;

      const result = await supabaseClient
        .from('entregas')
        .insert([{ fecha, supervisor, area: parseInt(area), cedula_colaborador: cedula, nombre_colaborador: nombre }])
        .select();

      if (!result.data || !result.data[0]) {
        alert("❌ Error guardando entrega");
        console.error(result);
        return;
      }

      const entregaId = result.data[0].id;
      const detalles = [];

      document.querySelectorAll('.epp-group').forEach(grupo => {
        const epp = grupo.querySelector('.epp-select').value;
        const codigo = grupo.querySelector('.codigo').value;
        if (epp && codigo) {
          detalles.push({ id_entrega: entregaId, epp, codigo });
        }
      });

      if (detalles.length > 0) {
        const res = await supabaseClient.from('detalle_entregas').insert(detalles);
        if (res.error) {
          alert("❌ Error guardando detalles");
          console.error(res.error);
          return;
        }
      }

      alert("✅ Entrega registrada con éxito");
      e.target.reset();
      setFechaHoy();
      document.getElementById('cedula_colaborador').value = '';
      document.getElementById('epp-container').innerHTML = '';
      agregarEPP();
    });
  </script>
</body>
</html>

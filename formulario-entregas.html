<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario de Entregas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary-color: #2980b9;
      --primary-dark: #1c5985;
      --secondary-color: #7f8c8d;
      --secondary-dark: #6c7a7d;
      --text-color: #2c3e50;
      --light-gray: #f2f2f2;
      --medium-gray: #ddd;
      --white: #ffffff;
      --border-radius: 8px;
      --box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--light-gray);
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }

    .form-container {
      background-color: var(--white);
      max-width: 100%;
      margin: 0;
      padding: 20px;
      box-shadow: var(--box-shadow);
    }

    h1 {
      text-align: center;
      color: var(--text-color);
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: var(--text-color);
    }

    select, input[type="text"], input[type="date"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: var(--border-radius);
      border: 1px solid var(--medium-gray);
      font-size: 16px;
      background-color: var(--white);
      transition: var(--transition);
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(41, 128, 185, 0.2);
    }

    .epp-group {
      background: var(--light-gray);
      padding: 15px;
      border: 1px solid var(--medium-gray);
      border-radius: var(--border-radius);
      margin-bottom: 15px;
      position: relative;
    }

    button {
      width: 100%;
      padding: 12px;
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: var(--transition);
      margin-top: 10px;
    }

    button:hover {
      background-color: var(--primary-dark);
    }

    button.secondary {
      background-color: var(--secondary-color);
      margin-bottom: 15px;
    }

    button.secondary:hover {
      background-color: var(--secondary-dark);
    }

    .required:after {
      content: " *";
      color: #e74c3c;
    }

    /* Estilos responsive */
    @media (min-width: 600px) {
      .form-container {
        max-width: 700px;
        margin: 40px auto;
        padding: 30px;
        border-radius: 12px;
      }

      h1 {
        font-size: 2rem;
        margin-bottom: 30px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .full-width {
        grid-column: span 2;
      }
    }

    @media (min-width: 900px) {
      .form-grid {
        grid-template-columns: 1fr 1fr 1fr;
      }

      .full-width {
        grid-column: span 3;
      }
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h1>Entrega de EPPs</h1>
    <form id="form-entrega">
      <div class="form-grid">
        <div class="form-group">
          <label class="required">Fecha:</label>
          <input type="date" id="fecha" required>
        </div>

        <div class="form-group">
          <label class="required">Supervisor:</label>
          <select id="supervisor" required></select>
        </div>

        <div class="form-group">
          <label class="required">Área:</label>
          <select id="area" required></select>
        </div>

        <div class="form-group">
          <label class="required">Nombre del colaborador:</label>
          <select id="nombre_colaborador" required></select>
        </div>

        <div class="form-group">
          <label>Cédula del colaborador:</label>
          <input type="text" id="cedula_colaborador" disabled>
        </div>

        <div class="full-width" id="epp-container">

	<div class="epp-group">
  	  <label class="required">EPP (Descripción):</label>
  	  <select class="epp-select" required></select>
  	  <input type="hidden" class="codigo">
  	  <label class="required">Cantidad:</label>
  	  <input type="number" class="cantidad" min="1" value="1" required>
	</div>

       </div>
      </div>

      <button type="button" onclick="agregarEPP()" class="secondary">➕ Agregar otro EPP</button>
      <button type="submit">Guardar entrega</button>
    </form>
  </div>


  <script>
    const supabaseClient = supabase.createClient(
      'https://jvcuujwkniicekolwljs.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2Y3V1andrbmlpY2Vrb2x3bGpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyMzE5MzgsImV4cCI6MjA2ODgwNzkzOH0.OFjrtoY0c9SLoDyNYuANxhCSA22cmTyAYfI8ceTICZ8'
    );

    document.addEventListener("DOMContentLoaded", async () => {
      const today = new Date();
      document.getElementById('fecha').value = today.toISOString().split("T")[0];

      await llenarSupervisorDesdeSesion();
      cargarDatos();
    });

    async function llenarSupervisorDesdeSesion() {
      const cedula = localStorage.getItem('cedula');
      if (!cedula) {
        alert("⚠️ No hay sesión activa. Vuelva a iniciar sesión.");
        window.location.href = "index.html";
        return;
      }

      const { data, error } = await supabaseClient
        .from('supervisores')
        .select('cedula, nombre_supervisor')
        .eq('cedula', cedula)
        .single();

      if (error || !data) {
        alert("❌ No se pudo cargar el nombre del supervisor.");
        console.error(error);
        return;
      }

      const supervisorSelect = document.getElementById('supervisor');
      supervisorSelect.innerHTML = '';
      const option = document.createElement('option');
      option.value = data.cedula;
      option.textContent = data.nombre_supervisor;
      supervisorSelect.appendChild(option);
      supervisorSelect.disabled = true;
    }

    async function cargarDatos() {
      const [areas, colaboradores, epps] = await Promise.all([
        supabaseClient.from('area').select('id, area'),
        supabaseClient.from('colaboradores').select('cedula, nombre_colaborador'),
        supabaseClient.from('epp').select('codigo, descripcion')
      ]);

      llenarSelect('area', areas.data, 'id', 'area');
      llenarSelect('nombre_colaborador', colaboradores.data, 'cedula', 'nombre_colaborador');

      document.querySelectorAll('.epp-select').forEach(select => {
        llenarSelectEPP(select, epps.data);
      });

      document.getElementById('nombre_colaborador').addEventListener('change', e => {
        const cedula = e.target.value;
        document.getElementById('cedula_colaborador').value = cedula || '';
      });
    }

    function llenarSelect(id, data, valueKey, textKey) {
      const select = document.getElementById(id);
      select.innerHTML = '<option value="">Seleccione...</option>';
      data.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item[valueKey];
        opt.textContent = item[textKey];
        select.appendChild(opt);
      });
    }

    function llenarSelectEPP(select, epps) {
      select.innerHTML = '<option value="">Seleccione...</option>';
      epps.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.codigo;
        opt.textContent = item.descripcion;
        select.appendChild(opt);
      });
      select.addEventListener('change', e => {
        const codigo = e.target.value;
        const inputCodigo = e.target.closest('.epp-group').querySelector('.codigo');
        inputCodigo.value = codigo || '';
      });
    }

    function agregarEPP() {
      const container = document.getElementById('epp-container');
      const grupo = document.querySelector('.epp-group');
      const nuevo = grupo.cloneNode(true);
      nuevo.querySelector('.codigo').value = '';
      container.appendChild(nuevo);

      supabaseClient.from('epp').select('codigo, descripcion').then(({ data }) => {
        llenarSelectEPP(nuevo.querySelector('.epp-select'), data);
      });
    }

    document.getElementById('form-entrega').addEventListener('submit', async (e) => {
      e.preventDefault();

      const fecha = document.getElementById('fecha').value;
      const supervisor = document.getElementById('supervisor').value;
      const area = document.getElementById('area').value;
      const cedula = document.getElementById('cedula_colaborador').value;
      const nombre = document.getElementById('nombre_colaborador').selectedOptions[0]?.textContent;

      const result = await supabaseClient
        .from('entregas')
        .insert([{ fecha, supervisor, area: parseInt(area), cedula_colaborador: cedula, nombre_colaborador: nombre }])
        .select();

      if (!result.data || !result.data[0]) {
        alert("❌ Error guardando entrega");
        console.error(result);
        return;
      }

      const entregaId = result.data[0].id;
      const detalles = [];



	document.querySelectorAll('.epp-group').forEach(grupo => {
  	  const select = grupo.querySelector('.epp-select');
  	  const codigo = select.value;
  	  const descripcion = select.selectedOptions[0]?.textContent || '';
  	  const cantidad = parseInt(grupo.querySelector('.cantidad').value) || 1;
  	  if (codigo && descripcion) {
    		detalles.push({id_entrega: entregaId, codigo, descripcion_epp: descripcion, cantidad});

        }
      });

      if (detalles.length > 0) {
        const res = await supabaseClient.from('detalle_entregas').insert(detalles);
        if (res.error) {
          alert("❌ Error guardando detalles");
          console.error(res.error);
          return;
        }
      }

      alert("✅ Entrega registrada con éxito");
      e.target.reset();
      document.getElementById('fecha').value = new Date().toISOString().split("T")[0];
      document.getElementById('cedula_colaborador').value = '';
      document.getElementById('epp-container').innerHTML = '';

      const { data: epps } = await supabaseClient.from('epp').select('codigo, descripcion');
      const container = document.getElementById('epp-container');
      const grupo = document.createElement('div');
      grupo.className = 'epp-group';
      grupo.innerHTML = `
        <label>EPP (Descripción):</label>
        <select class="epp-select" required></select>
        <input type="hidden" class="codigo">
      `;
      container.appendChild(grupo);
      llenarSelectEPP(grupo.querySelector('.epp-select'), epps);
    });
  </script>
</body>
</html>



